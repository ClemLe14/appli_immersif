<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Évaluation de l'Environnement Immersif</title>
  <style>
    body {
      background-color: orange;
      font-family: Arial, sans-serif;
      text-align: center;
      margin: 0;
      padding: 20px;
      box-sizing: border-box;
    }
    .container {
      background: white;
      padding: 20px;
      border-radius: 10px;
      width: 90%;
      max-width: 800px;
      margin: 20px auto;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      position: relative;
      z-index: 1;
    }
    h2, h3, h4 {
      margin-top: 0;
    }
    .hidden {
      display: none !important;
    }
    .disabled {
      background: gray !important;
      cursor: not-allowed !important;
    }
    /* .done {  // On retire ceci si on ne veut plus colorer en vert
      background: #4caf50 !important;
      color: #fff !important;
    } */
    button {
      background: #333;
      color: white;
      padding: 10px 15px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      margin-top: 10px;
    }
    button:hover {
      opacity: 0.9;
    }
    .step-button {
      display: block;
      width: 90%;
      padding: 15px;
      margin: 10px auto;
      border: none;
      border-radius: 5px;
      font-size: 16px;
    }
    input[type="email"] {
      width: 80%;
      padding: 10px;
      margin: 10px 0;
      font-size: 16px;
    }
    textarea {
      width: 90%;
      padding: 10px;
      margin: 10px 0;
      border: 1px solid #ccc;
      border-radius: 5px;
      min-height: 60px;
      background: #fafafa;
    }

    /* Menu des étapes */
    .menu-steps {
      text-align: left;
      margin: 20px auto;
      width: 80%;
      max-width: 500px;
    }

    /* Sous-menu Étape 2 */
    .sub-menu {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 20px;
      margin-bottom: 20px;
    }
    /* Facteurs (Étape 2 - Module1) */
    .factor-block {
      background: #fefefe;
      border-radius: 8px;
      margin: 20px 0;
      padding: 15px;
      box-shadow: 0 0 3px rgba(0,0,0,0.1);
      text-align: left;
      position: relative;
    }
    .cards-zone {
      margin: 10px auto;
      padding: 10px;
      min-height: 10px;
      text-align: left;
    }
    .card-container {
      margin: 10px 0;
      border: 1px solid #eee;
      border-radius: 5px;
      padding: 10px;
      position: relative;
      background: #ececec;
    }
    .remove-card {
      position: absolute;
      top: 5px;
      right: 5px;
      color: red;
      cursor: pointer;
      font-weight: bold;
    }
    .drop-zone {
      margin: 10px auto;
      width: 220px;
      height: 60px;
      border: 2px dashed #999;
      border-radius: 5px;
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: #f9f9f9;
      transition: border-color 0.2s;
    }
    .drop-zone.filled {
      border: 2px solid #4caf50;
      background-color: #eaffea;
      color: black;
    }

    /* Correction (Module 2) */
    .purple-card {
      background-color: #b67ae0; /* plus visible */
      color: #fff;
      font-weight: bold;
      padding: 20px;     
      border-radius: 8px;
      cursor: pointer;
      width: 300px;      
      margin: 0 auto;
      text-align: center;
      margin-top: 10px;
      position: relative;
      transition: all 0.3s;
      min-height: 80px;  
    }
    .purple-card:hover {
      opacity: 0.9;
    }
    .purple-card .hidden-content {
      display: none;
      margin-top: 10px;
      background: #fff;
      color: #333;
      border-radius: 5px;
      padding: 10px;
      text-align: left;
    }

    /* Tooltip (petit i) */
    .info-icon-container {
      display: inline-block;
      position: relative;
      margin-left: 8px;
      cursor: pointer;
    }
    .info-icon {
      background: red;
      color: #fff;
      font-weight: bold;
      border-radius: 50%;
      padding: 2px 6px;
      border: 2px solid #fff;
      font-size: 12px;
    }
    .info-icon-container .tooltip-text {
      visibility: hidden;
      width: 280px;
      background-color: #333;
      color: #fff;
      text-align: left;
      border-radius: 5px;
      padding: 8px;
      position: absolute;
      top: 25px;
      left: -70px;
      z-index: 999;
      font-size: 14px;
      opacity: 0;
      transition: opacity 0.3s;
    }
    .info-icon-container:hover .tooltip-text {
      visibility: visible;
      opacity: 1;
    }

    /* Cartes vertes => plus grandes pour ne pas tronquer */
    .tags-panel {
      position: fixed;
      top: 120px;
      right: 0;
      width: 120px;
      background: #4caf50;
      border-top-left-radius: 10px;
      border-bottom-left-radius: 10px;
      padding: 10px 5px;
      z-index: 9999;
      display: none;
      flex-direction: column;
      align-items: flex-end;
      gap: 10px;
    }
    .tags-panel.show {
      display: flex !important;
    }
    .playing-card {
      width: 120px;
      height: 80px;
      background: #98ee99;
      border-radius: 8px;
      cursor: grab;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      position: relative;
      transition: all 0.3s;
      text-align: left;
      color: #085400;
      overflow: hidden;
    }
    .playing-card:hover {
      width: 240px; 
      height: 200px;
    }
    .card-title {
      font-weight: bold;
      font-size: 14px;
      margin: 6px;
      color: #085400;
    }
    .card-body {
      display: none;
      padding: 0 6px 6px 6px;
      font-size: 12px;
    }
    .playing-card:hover .card-body {
      display: block;
    }
  </style>
</head>
<body>

  <!-- 1) PAGE EMAIL -->
  <div class="container" id="emailSection">
    <h2>Entrez votre email pour commencer</h2>
    <input type="email" id="userEmail" placeholder="Entrez votre email ici...">
    <button onclick="saveEmail()">Commencer</button>
  </div>

  <!-- 2) MENU ÉTAPES -->
  <div class="container hidden" id="steps">
    <h2>Bienvenue dans l'application</h2>
    <div class="menu-steps">
      <!-- Étape 1 -->
      <button id="step1-btn" class="step-button"
              onclick="showStep('step1')">
        Étape 1 : Analyse Critique
      </button>
      <!-- Étape 2 -->
      <button id="step2-btn" class="step-button disabled" disabled
              onclick="showStep('step2')">
        Étape 2 : Non débloquée
      </button>
      <!-- Étape 3 -->
      <button id="step3-btn" class="step-button disabled" disabled
              onclick="showStep('step3')">
        Étape 3 : Non débloquée
      </button>
      <!-- Étape 4 -->
      <button id="step4-btn" class="step-button disabled" disabled
              onclick="showStep('step4')">
        Étape 4 : Non débloquée
      </button>
    </div>
  </div>

  <!-- ÉTAPE 1 (inchangé) -->
  <div class="container hidden" id="step1">
    <h3>Étape 1 : Analyse Critique</h3>
    <p style="text-align:left;">
      <strong>Qu'avez-vous ressenti pendant que vous étiez exposé à l'environnement immersif ?</strong><br/>
      Pour chaque composante, indiquez si oui ou non vous l'avez ressentie.  
      Puis, que vous l'ayez ressentie ou non, décrivez pourquoi en quelques phrases.
    </p>

    <!-- 6 questions (inchangées) -->
    <div id="question1">
      <p><strong>Présence de soi :</strong></p>
      <label><input type="radio" name="presence" value="oui"> Oui</label>
      <label><input type="radio" name="presence" value="non"> Non</label>
      <p>Pourquoi ?</p>
      <textarea id="presenceWhy" oninput="showNextQ(1,2)"></textarea>
    </div>
    <div id="question2" class="hidden">
      <p><strong>Modèle mental :</strong></p>
      <label><input type="radio" name="model" value="oui"> Oui</label>
      <label><input type="radio" name="model" value="non"> Non</label>
      <p>Pourquoi ?</p>
      <textarea id="modelWhy" oninput="showNextQ(2,3)"></textarea>
    </div>
    <div id="question3" class="hidden">
      <p><strong>Émotion :</strong></p>
      <label><input type="radio" name="emotion" value="oui"> Oui</label>
      <label><input type="radio" name="emotion" value="non"> Non</label>
      <p>Pourquoi ?</p>
      <textarea id="emotionWhy" oninput="showNextQ(3,4)"></textarea>
    </div>
    <div id="question4" class="hidden">
      <p><strong>Jugement :</strong></p>
      <label><input type="radio" name="judgement" value="oui"> Oui</label>
      <label><input type="radio" name="judgement" value="non"> Non</label>
      <p>Pourquoi ?</p>
      <textarea id="judgementWhy" oninput="showNextQ(4,5)"></textarea>
    </div>
    <div id="question5" class="hidden">
      <p><strong>Implication :</strong></p>
      <label><input type="radio" name="implication" value="oui"> Oui</label>
      <label><input type="radio" name="implication" value="non"> Non</label>
      <p>Pourquoi ?</p>
      <textarea id="implicationWhy" oninput="showNextQ(5,6)"></textarea>
    </div>
    <div id="question6" class="hidden">
      <p><strong>Suspension de l'incrédulité :</strong></p>
      <label><input type="radio" name="suspension" value="oui"> Oui</label>
      <label><input type="radio" name="suspension" value="non"> Non</label>
      <p>Pourquoi ?</p>
      <textarea id="suspensionWhy" oninput="enableFinishStep1()"></textarea>

      <button class="hidden" id="finishStep1Btn"
              onclick="finishStep1()">
        Enregistrer et revenir au menu
      </button>
    </div>
  </div>

  <!-- ÉTAPE 2 : FACTEURS + CORRECTION -->
  <div class="container hidden" id="step2">
    <h2>Étape 2 : Facteurs à modifier</h2>
    <div class="sub-menu">
      <button id="module1-btn" class="disabled" disabled
              onclick="showModule('module1')">Facteurs</button>
      <button id="module2-btn" class="disabled" disabled
              onclick="showModule('module2')">Correction</button>
    </div>

    <!-- MODULE 1 : FACTEURS -->
    <div id="module1" class="hidden">
      <h3>Facteurs</h3>
      <!-- Consigne demandée -->
      <p><em>Pour chaque facteur, indiquez votre ressenti, là ou les amélioration.s possible.s 
      et leur.s impact.s sur la ou les composante.s du sentiment de présence.</em></p>

      <!-- FACTEUR 1 -->
      <div class="factor-block" id="factor1">
        <h4>Facteur 1 : Technologique
          <span class="info-icon-container">
            <span class="info-icon">i</span>
            <span class="tooltip-text">
              Les facteurs technologiques renvoient à tout ce qui concerne 
              le matériel utilisé et l’immersion (basée sur la forme du média, 
              l’enveloppement sensoriel...) ainsi que l’interaction 
              (aspect naturel, contrôle, interface).
            </span>
          </span>
        </h4>
        <p><strong>Quel est votre ressenti ?</strong></p>
        <textarea id="facteur1_ressenti" oninput="checkFactorCompletion(1)"></textarea>
        <p><strong>Qu'est-ce qu'on pourrait améliorer ?</strong></p>
        <textarea id="facteur1_ameliorer" oninput="checkFactorCompletion(1)"></textarea>
        <p><strong>Quelle(s) composante(s) ?</strong></p>
        <div class="cards-zone" id="factor1-cards">
          <div class="card-container">
            <div class="remove-card" onclick="removeCard(this)">x</div>
            <div class="drop-zone" data-value=""
                 ondragover="onDragOver(event)"
                 ondrop="onDrop(event,1)">
              <span>Glissez une composante ici</span>
            </div>
            <p><strong>Commentaire :</strong></p>
            <textarea class="commentaire" oninput="checkFactorCompletion(1)"></textarea>
          </div>
        </div>
        <button onclick="addCard('factor1-cards',1)">+ Ajouter un encadré</button>
      </div>

      <!-- FACTEUR 2 -->
      <div class="factor-block hidden" id="factor2">
        <h4>Facteur 2 : Environnemental
          <span class="info-icon-container">
            <span class="info-icon">i</span>
            <span class="tooltip-text">
              Les facteurs environnementaux renvoient à la cohérence/réalisme 
              de l’environnement, la narration, la difficulté, la nature de la tâche, etc.
            </span>
          </span>
        </h4>
        <p><strong>Quel est votre ressenti ?</strong></p>
        <textarea id="facteur2_ressenti" oninput="checkFactorCompletion(2)"></textarea>
        <p><strong>Qu'est-ce qu'on pourrait améliorer ?</strong></p>
        <textarea id="facteur2_ameliorer" oninput="checkFactorCompletion(2)"></textarea>
        <p><strong>Quelle(s) composante(s) ?</strong></p>
        <div class="cards-zone" id="factor2-cards">
          <div class="card-container">
            <div class="remove-card" onclick="removeCard(this)">x</div>
            <div class="drop-zone" data-value=""
                 ondragover="onDragOver(event)"
                 ondrop="onDrop(event,2)">
              <span>Glissez une composante ici</span>
            </div>
            <p><strong>Commentaire :</strong></p>
            <textarea class="commentaire" oninput="checkFactorCompletion(2)"></textarea>
          </div>
        </div>
        <button onclick="addCard('factor2-cards',2)">+ Ajouter un encadré</button>
      </div>

      <!-- FACTEUR 3 -->
      <div class="factor-block hidden" id="factor3">
        <h4>Facteur 3 : Individuel
          <span class="info-icon-container">
            <span class="info-icon">i</span>
            <span class="tooltip-text">
              Les facteurs individuels renvoient aux traits de personnalité, 
              propension à l’immersion, troubles psychologiques, etc.
            </span>
          </span>
        </h4>
        <p><strong>Quel est votre ressenti ?</strong></p>
        <textarea id="facteur3_ressenti" oninput="checkFactorCompletion(3)"></textarea>
        <p><strong>Qu'est-ce qu'on pourrait améliorer ?</strong></p>
        <textarea id="facteur3_ameliorer" oninput="checkFactorCompletion(3)"></textarea>
        <p><strong>Quelle(s) composante(s) ?</strong></p>
        <div class="cards-zone" id="factor3-cards">
          <div class="card-container">
            <div class="remove-card" onclick="removeCard(this)">x</div>
            <div class="drop-zone" data-value=""
                 ondragover="onDragOver(event)"
                 ondrop="onDrop(event,3)">
              <span>Glissez une composante ici</span>
            </div>
            <p><strong>Commentaire :</strong></p>
            <textarea class="commentaire" oninput="checkFactorCompletion(3)"></textarea>
          </div>
        </div>
        <button onclick="addCard('factor3-cards',3)">+ Ajouter un encadré</button>
      </div>

      <button class="hidden" id="saveFactorBtn" onclick="closeModule1()">
        Enregistrer et revenir aux modules
      </button>
    </div>

    <!-- MODULE 2 : CORRECTION -->
    <div id="module2" class="hidden">
      <h3>Correction</h3>
      <p>Voici quelques éléments pour chaque facteur :</p>

      <!-- Facteur techno -->
      <div style="background:#fafafa; padding:20px; border-radius:10px; margin-top:20px; text-align:left;">
        <h4>Facteur Technologique</h4>
        <p>
          Les facteurs technologiques renvoient à tout ce qui concerne 
          le matériel utilisé et l’immersion (basée sur la forme du média, 
          l’enveloppement sensoriel...) ainsi que l’interaction 
          (aspect naturel, contrôle, interface).
        </p>
        <!-- Carte violette -->
        <div class="purple-card" id="purpleTechno"
             onclick="revealIdeaInCard('purpleTechno','Amélioration de la spatialisation du son => amélioration de limagerie mentale.')">
          <span>Idée à révéler</span>
          <div class="hidden-content"></div>
        </div>

        <p style="margin-top:10px;"><strong>Vos autres notes :</strong></p>
        <textarea id="note_techno" oninput="checkAllNotesFilled()" placeholder="Notez ici vos remarques / idées..."></textarea>
      </div>

      <!-- Facteur environnemental -->
      <div style="background:#fafafa; padding:20px; border-radius:10px; margin-top:20px; text-align:left;">
        <h4>Facteur Environnemental</h4>
        <p>
          Les facteurs environnementaux renvoient à la cohérence/réalisme 
          de l’environnement, la narration, la difficulté, la nature de la tâche, etc.
        </p>
        <!-- Carte violette -->
        <div class="purple-card" id="purpleEnv"
             onclick="revealIdeaInCard('purpleEnv','Ajout dune narration introductive => amélioration du jugement de crédibilité (attentes).')">
          <span>Idée à révéler</span>
          <div class="hidden-content"></div>
        </div>

        <p style="margin-top:10px;"><strong>Vos autres notes :</strong></p>
        <textarea id="note_env" oninput="checkAllNotesFilled()" placeholder="Notez ici vos remarques / idées..."></textarea>
      </div>

      <!-- Facteur individuel -->
      <div style="background:#fafafa; padding:20px; border-radius:10px; margin-top:20px; text-align:left;">
        <h4>Facteur Individuel</h4>
        <p>
          Les facteurs individuels renvoient aux traits de personnalité, 
          propension à l’immersion, troubles psychologiques, etc.
        </p>
        <!-- Carte violette -->
        <div class="purple-card" id="purpleIndiv"
             onclick="revealIdeaInCard('purpleIndiv','Adaptation aux interets de lutisateur => amélioration de limplication.')">
          <span>Idée à révéler</span>
          <div class="hidden-content"></div>
        </div>

        <p style="margin-top:10px;"><strong>Vos autres notes :</strong></p>
        <textarea id="note_indiv" oninput="checkAllNotesFilled()" placeholder="Notez ici vos remarques / idées..."></textarea>
      </div>

      <!-- Bouton pour valider et revenir au menu -->
      <button id="saveCorrectionBtn" class="hidden" onclick="completeStep2()">Enregistrer et revenir au menu précédent</button>
    </div>
  </div>

  <!-- ÉTAPE 3 -->
  <div class="container hidden" id="step3">
    <h2>Étape 3 : Priorisation</h2>
    <p>Si nous devions choisir 3 éléments à modifier en priorité, quels seraient-ils ?</p>

    <div style="background:#76a9ff; padding:20px; border-radius:10px; margin:20px auto; text-align:left; color:#fff; max-width:600px;">
      <h4>Priorité 1</h4>
      <textarea id="prio1"></textarea>
      <h4>Priorité 2</h4>
      <textarea id="prio2"></textarea>
      <h4>Priorité 3</h4>
      <textarea id="prio3"></textarea>
    </div>

    <p>Idées possibles à révéler :</p>
    <!-- 3 cartes violettes "Idée à révéler" -->
    <div class="purple-card" id="narrationCard"
         onclick="revealIdeaInCard('narrationCard','Narration : ajouter davantage de contexte pour renforcer limmersion.')"
         style="margin-bottom:10px;">
      <span>Idée à révéler</span>
      <div class="hidden-content"></div>
    </div>

    <div class="purple-card" id="interactionCard"
         onclick="revealIdeaInCard('interactionCard','Interaction : autoriser plus dactions ou de feedback pour maintenir lattention.')"
         style="margin-bottom:10px;">
      <span>Idée à révéler</span>
      <div class="hidden-content"></div>
    </div>

    <div class="purple-card" id="gamificationCard"
         onclick="revealIdeaInCard('gamificationCard','Gamification : intégrer des éléments de jeu (scores, défis, récompenses) pour motiver lutilisateur.')">
      <span>Idée à révéler</span>
      <div class="hidden-content"></div>
    </div>

    <!-- Bouton pour terminer l'étape 3 et débloquer l'étape 4 -->
    <button onclick="finishStep3()">Terminer l'étape 3</button>
  </div>

  <!-- ÉTAPE 4 -->
  <div class="container hidden" id="step4">
    <h2>Étape 4 : Récapitulatif</h2>
    <p>Cliquez sur le bouton pour télécharger tout ce que vous avez saisi.</p>

    <div id="recapAnswers">
      <p><strong>Email :</strong> <span id="recap_email"></span></p>
      <p><strong>Présence :</strong> <span id="recap_presence"></span></p>
      <hr/>
      <p>
        <strong>Priorité 1 :</strong> <span id="recap_prio1"></span><br/>
        <strong>Priorité 2 :</strong> <span id="recap_prio2"></span><br/>
        <strong>Priorité 3 :</strong> <span id="recap_prio3"></span>
      </p>
    </div>

    <button onclick="downloadAllAnswers()">Télécharger vos réponses</button>
    <button onclick="showStep('steps')">Revenir au menu</button>
  </div>

  <!-- 6 CARTES VERTES (Module1) AVEC DESCRIPTIONS COMPLÈTES -->
  <div class="tags-panel" id="tagsPanel">
    <div class="playing-card" draggable="true" ondragstart="onDragStart(event)" data-value="Présence de soi">
      <div class="card-title">Présence de soi</div>
      <div class="card-body">
        Correspond au sentiment subjectif d'être physiquement présent 
        et d'avoir une représentation mentale de son propre corps 
        dans un environnement immersif.<br/><br/>
        Elle repose sur :
        <ul>
          <li>l'incarnation</li>
          <li>l'agentivité</li>
          <li>les possibilités d'action/interaction</li>
        </ul>
      </div>
    </div>

    <div class="playing-card" draggable="true" ondragstart="onDragStart(event)" data-value="Modèle mental">
      <div class="card-title">Modèle mental</div>
      <div class="card-body">
        Désigne la manière dont une personne construit et organise 
        une représentation cognitive pouvant être multisensorielle, 
        à partir des informations qu'elle perçoit.<br/><br/>
        Il comprend plusieurs niveaux :
        <ul>
          <li>l'imagerie simple</li>
          <li>l'imagerie complexe</li>
          <li>l'imagerie fonctionnelle</li>
        </ul>
      </div>
    </div>

    <div class="playing-card" draggable="true" ondragstart="onDragStart(event)" data-value="Émotion">
      <div class="card-title">Émotion</div>
      <div class="card-body">
        Fait référence aux réponses affectives de courte durée 
        déclenchées par une situation et leur influence sur 
        l'expérience vécue.<br/><br/>
        Elles reposent sur :
        <ul>
          <li>L'intensité et la valence</li>
          <li>La motivation émotionnelle</li>
        </ul>
      </div>
    </div>

    <div class="playing-card" draggable="true" ondragstart="onDragStart(event)" data-value="Jugement">
      <div class="card-title">Jugement</div>
      <div class="card-body">
        Correspond à l'évaluation subjective de la crédibilité 
        de l'environnement immersif basée sur sa cohérence, 
        nos connaissances et nos attentes.<br/><br/>
        Il repose sur :
        <ul>
          <li>La cohérence</li>
          <li>La correspondance aux attentes antérieures</li>
        </ul>
      </div>
    </div>

    <div class="playing-card" draggable="true" ondragstart="onDragStart(event)" data-value="Implication">
      <div class="card-title">Implication</div>
      <div class="card-body">
        Renvoie à l'attention portée à une expérience, 
        à la perception du temps et au degré d'investissement 
        mental dans l'environnement immersif vs. l'environnement réel.<br/><br/>
        Elle se manifeste par :
        <ul>
          <li>Une concentration attentionnelle</li>
          <li>Un indiçage de la pensée</li>
          <li>Une non-conscience du temps qui passe</li>
        </ul>
      </div>
    </div>

    <div class="playing-card" draggable="true" ondragstart="onDragStart(event)" data-value="Suspension de l'incrédulité">
      <div class="card-title">Suspension</div>
      <div class="card-body">
        Désigne la volonté d'un individu à accepter l'environnement immersif 
        comme réel, en faisant abstraction des incohérences 
        qui pourraient briser l'illusion.
      </div>
    </div>
  </div>

  <script>
    /************************************************************
     * GLOBALES                                                 *
     ************************************************************/
    let draggedTag = null;

    /************************************************************
     * 1) DEMANDE EMAIL => DÉBLOQUE ÉTAPE 1                     *
     ************************************************************/
    function saveEmail() {
      const emailVal = document.getElementById("userEmail").value.trim();
      const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if(!re.test(emailVal)){
        alert("Email invalide");
        return;
      }
      localStorage.setItem("userEmail", emailVal);
      document.getElementById("emailSection").classList.add("hidden");
      document.getElementById("steps").classList.remove("hidden");

      // Étape 1
      const step1Btn=document.getElementById("step1-btn");
      step1Btn.classList.remove("disabled");
      step1Btn.disabled=false;
      step1Btn.innerText="Étape 1 : Analyse Critique";
    }

    /************************************************************
     * 2) SHOW STEP                                             *
     ************************************************************/
    function showStep(stepId){
      document.querySelectorAll(".container").forEach(el=>el.classList.add("hidden"));
      document.getElementById("tagsPanel").classList.remove("show");

      // Étape 4 => on recharge le récap
      if(stepId==="step4") loadRecap();

      const d=document.getElementById(stepId);
      if(d)d.classList.remove("hidden");
    }

    /************************************************************
     * 3) ÉTAPE 1 => 6 Q => Q6 => débloque ÉTAPE2               *
     ************************************************************/
    function showNextQ(curr, next){
      const txt=document.getElementById("question"+curr).querySelector("textarea");
      if(txt && txt.value.trim()!==""){
        document.getElementById("question"+next).classList.remove("hidden");
      }
    }
    function enableFinishStep1(){
      document.getElementById("finishStep1Btn").classList.remove("hidden");
    }
    function finishStep1(){
      // Débloquer Étape 2
      const step2Btn=document.getElementById("step2-btn");
      step2Btn.classList.remove("disabled");
      step2Btn.disabled=false;
      step2Btn.innerText="Étape 2 : Facteurs à modifier";

      // Débloquer Module 1
      const module1Btn=document.getElementById("module1-btn");
      module1Btn.classList.remove("disabled");
      module1Btn.disabled=false;
      module1Btn.innerText="Facteurs";

      showStep("steps");
    }

    /************************************************************
     * 4) ÉTAPE 2 => Module1 / Module2                          *
     ************************************************************/
    function showModule(moduleId){
      document.getElementById("module1").classList.add("hidden");
      document.getElementById("module2").classList.add("hidden");
      document.getElementById("tagsPanel").classList.remove("show");

      if(moduleId==="module1"){
        document.getElementById("module1").classList.remove("hidden");
        document.getElementById("tagsPanel").classList.add("show");
      } else if(moduleId==="module2"){
        document.getElementById("module2").classList.remove("hidden");
      }
    }

    /************************************************************
     * 5) FACTEURS => checkFactorCompletion(...)               *
     ************************************************************/
    function checkFactorCompletion(num){
      const r=document.getElementById("facteur"+num+"_ressenti").value.trim();
      const a=document.getElementById("facteur"+num+"_ameliorer").value.trim();
      const zone=document.getElementById("factor"+num+"-cards");

      let hasValidCard=false;
      zone.querySelectorAll(".card-container").forEach(c=>{
        const dz=c.querySelector(".drop-zone");
        const co=c.querySelector(".commentaire");
        if(dz && co){
          const comp=dz.getAttribute("data-value")||"";
          const val=co.value.trim();
          if(comp!=="" && val!==""){
            hasValidCard=true;
          }
        }
      });
      if(r!=="" && a!=="" && hasValidCard){
        // On débloque le facteur suivant OU le bouton d'enregistrement
        const nextF=document.getElementById("factor"+(num+1));
        if(nextF) {
          nextF.classList.remove("hidden");
        } else {
          document.getElementById("saveFactorBtn").classList.remove("hidden");
        }
      }
    }
    function removeCard(el){
      el.parentElement.remove();
    }
    function addCard(containerId,factorNum){
      const c=document.getElementById(containerId);
      if(!c)return;
      const existing=c.querySelectorAll(".card-container").length;
      if(existing>=4){
        alert("Max 4 encadrés");
        return;
      }
      const card=document.createElement("div");
      card.classList.add("card-container");
      card.innerHTML=`
        <div class="remove-card" onclick="removeCard(this)">x</div>
        <div class="drop-zone" data-value=""
             ondragover="onDragOver(event)"
             ondrop="onDrop(event,${factorNum})">
          <span>Glissez une composante ici</span>
        </div>
        <p><strong>Commentaire :</strong></p>
        <textarea class="commentaire" oninput="checkFactorCompletion(${factorNum})"></textarea>
      `;
      c.appendChild(card);
    }
    function onDragStart(e){
      draggedTag=e.target;
    }
    function onDragOver(e){
      e.preventDefault();
    }
    function onDrop(e,factorNum){
      e.preventDefault();
      if(!draggedTag)return;
      const dropZ=e.currentTarget;
      const comp=draggedTag.getAttribute("data-value")||"";
      dropZ.innerHTML=comp;
      dropZ.classList.add("filled");
      dropZ.setAttribute("data-value",comp);

      checkFactorCompletion(factorNum);
    }
    function closeModule1(){
      // On revient au sub-menu
      showModule("");

      // On débloque le Module 2 (Correction)
      const module2Btn=document.getElementById("module2-btn");
      module2Btn.classList.remove("disabled");
      module2Btn.disabled=false;
      module2Btn.innerText="Correction";
    }

    /************************************************************
     * 6) MODULE2 => Correction => fin => Étape3                *
     ************************************************************/
    // Affiche l'idée directement dans la purple-card
    function revealIdeaInCard(cardId, ideaText){
      const card = document.getElementById(cardId);
      if(!card)return;
      const hiddenDiv = card.querySelector(".hidden-content");
      const spanText = card.querySelector("span");

      // Si le contenu est caché, on le révèle
      if(hiddenDiv && hiddenDiv.style.display!=="block"){
        spanText.textContent = "";            // enlève "Idée à révéler"
        hiddenDiv.textContent = ideaText;     // insère l'idée
        hiddenDiv.style.display = "block";    // on l'affiche
      }
    }

    // Vérifie si toutes les notes des 3 facteurs Correction sont remplies
    function checkAllNotesFilled(){
      const t1 = document.getElementById("note_techno").value.trim();
      const t2 = document.getElementById("note_env").value.trim();
      const t3 = document.getElementById("note_indiv").value.trim();

      // Si tous sont non vides, on affiche le bouton
      if(t1!=="" && t2!=="" && t3!==""){
        document.getElementById("saveCorrectionBtn").classList.remove("hidden");
      } else {
        document.getElementById("saveCorrectionBtn").classList.add("hidden");
      }
    }
    function completeStep2(){
      // Au lieu de .classList.add("done"), on ne fait rien de spécial
      // On débloque Étape 3
      const step3Btn=document.getElementById("step3-btn");
      step3Btn.classList.remove("disabled");
      step3Btn.disabled=false;
      step3Btn.innerText="Étape 3 : Priorisation";

      // On revient au menu principal
      showStep("steps");
    }

    /************************************************************
     * 7) ÉTAPE3 => On ajoute un bouton pour terminer           *
     ************************************************************/
    function finishStep3(){
      // Débloquer Étape 4
      const step4Btn=document.getElementById("step4-btn");
      step4Btn.classList.remove("disabled");
      step4Btn.disabled=false;
      step4Btn.innerText="Étape 4 : Récapitulatif";

      showStep("steps");
    }

    /************************************************************
     * 8) ÉTAPE4 => Récap + Téléchargement                      *
     ************************************************************/
    function loadRecap(){
      const email=localStorage.getItem("userEmail")||"";
      document.getElementById("recap_email").textContent=email;

      // Présence
      const presenceRadio=document.querySelector("input[name='presence']:checked");
      const presenceWhy=document.getElementById("presenceWhy")?.value||"";
      const presVal=presenceRadio ? presenceRadio.value+" - "+presenceWhy : "";
      document.getElementById("recap_presence").textContent=presVal;

      // 3 priorités
      document.getElementById("recap_prio1").textContent=document.getElementById("prio1").value;
      document.getElementById("recap_prio2").textContent=document.getElementById("prio2").value;
      document.getElementById("recap_prio3").textContent=document.getElementById("prio3").value;
    }

    // Génère un .txt contenant toutes les réponses
    function downloadAllAnswers(){
      let content = "=== EVALUATION DE L'ENVIRONNEMENT IMMERSIF ===\n\n";

      // 1) Email
      const email=localStorage.getItem("userEmail") || "";
      content += "Email : " + email + "\n\n";

      // 2) Réponses Étape 1
      content += "--- ETAPE 1 : Analyse Critique ---\n";
      const questions = [
        { name: "presence", label: "Présence de soi", whyId: "presenceWhy" },
        { name: "model", label: "Modèle mental", whyId: "modelWhy" },
        { name: "emotion", label: "Émotion", whyId: "emotionWhy" },
        { name: "judgement", label: "Jugement", whyId: "judgementWhy" },
        { name: "implication", label: "Implication", whyId: "implicationWhy" },
        { name: "suspension", label: "Suspension de l'incrédulité", whyId: "suspensionWhy" },
      ];
      questions.forEach(q=>{
        const radio=document.querySelector(`input[name='${q.name}']:checked`);
        const whyVal=document.getElementById(q.whyId)?.value.trim() || "";
        const radioVal=radio ? radio.value : "";
        content += `\n${q.label} : ${radioVal}\nPourquoi ? ${whyVal}\n`;
      });

      // 3) Étape 2 - Module1 : Facteurs
      content += "\n--- ETAPE 2 : Module Facteurs ---\n";
      for(let i=1; i<=3; i++){
        const r=document.getElementById(`facteur${i}_ressenti`)?.value.trim()||"";
        const a=document.getElementById(`facteur${i}_ameliorer`)?.value.trim()||"";

        content += `\nFacteur ${i} :\n`;
        content += `  Ressenti : ${r}\n`;
        content += `  Améliorer : ${a}\n`;

        // Cards
        const zone=document.getElementById(`factor${i}-cards`);
        if(zone){
          const cards=zone.querySelectorAll(".card-container");
          cards.forEach((c,index)=>{
            const dz=c.querySelector(".drop-zone");
            const co=c.querySelector(".commentaire");
            const comp=dz.getAttribute("data-value")||"";
            const com=co.value.trim();
            if(comp || com){
              content += `   - Encadré ${index+1} :\n`;
              content += `       Composante : ${comp}\n`;
              content += `       Commentaire : ${com}\n`;
            }
          });
        }
      }

      // Étape 2 - Module2 : Correction
      content += "\n--- ETAPE 2 : Module Correction ---\n";
      const noteTech = document.getElementById("note_techno")?.value.trim() || "";
      const noteEnv = document.getElementById("note_env")?.value.trim() || "";
      const noteIndiv = document.getElementById("note_indiv")?.value.trim() || "";
      content += `Facteur techno (notes) : ${noteTech}\n`;
      content += `Facteur env (notes)   : ${noteEnv}\n`;
      content += `Facteur indiv (notes) : ${noteIndiv}\n`;

      // 4) Étape 3 - 3 priorités
      content += "\n--- ETAPE 3 : Priorités ---\n";
      const p1=document.getElementById("prio1")?.value.trim() || "";
      const p2=document.getElementById("prio2")?.value.trim() || "";
      const p3=document.getElementById("prio3")?.value.trim() || "";
      content += `Priorité 1 : ${p1}\n`;
      content += `Priorité 2 : ${p2}\n`;
      content += `Priorité 3 : ${p3}\n`;

      // 5) Génération d'un fichier texte
      const blob = new Blob([content], { type: "text/plain" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "evaluation_immersive.txt";
      link.click();
    }
  </script>
</body>
</html>
